<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Restore | pgBackRest</title>
    <meta name="description" content="Reliable PostgreSQL Backup &amp; Restore">
    <link rel="icon" href="/pgbackrest-docs/logo.png">
    
    <link rel="preload" href="/pgbackrest-docs/assets/css/0.styles.18edf712.css" as="style"><link rel="preload" href="/pgbackrest-docs/assets/js/app.01ebea85.js" as="script"><link rel="preload" href="/pgbackrest-docs/assets/js/45.bf622f74.js" as="script"><link rel="prefetch" href="/pgbackrest-docs/assets/js/26.e11cc072.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/2.ea010887.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/3.b7507089.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/4.cfc39c6d.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/5.6b11616c.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/6.df92328a.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/7.58324044.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/8.c87957ea.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/9.0fb232f6.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/10.972bbafb.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/11.e78eb127.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/12.5928bd53.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/13.1c12197c.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/14.d84f628c.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/15.4adcb884.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/16.ef3b7049.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/17.9d3117d9.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/18.0bcae378.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/19.295fa193.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/20.94847527.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/21.b5e7b8b5.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/22.d07ad4dd.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/23.77d36072.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/24.6b6691b4.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/25.f9425e67.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/27.78d9feea.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/28.1f99e16d.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/29.28bb7045.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/30.cff46cbe.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/31.47660e90.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/32.9df22cac.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/33.37935b34.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/34.9706bcdc.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/35.5ec6e936.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/36.996e8c9b.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/37.4718e56d.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/38.b3445822.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/39.c3ad3059.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/40.567d1aff.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/41.d0b20dd8.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/42.663bd5fd.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/43.d28dcd20.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/44.2dd273bd.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/46.0d093936.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/47.4a1a0f05.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/48.808678bd.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/49.18e9d1eb.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/50.fa7ae22a.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/51.63339b12.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/52.8b737e70.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/53.974f5c76.js"><link rel="prefetch" href="/pgbackrest-docs/assets/js/54.9d3ce5c2.js">
    <link rel="stylesheet" href="/pgbackrest-docs/assets/css/0.styles.18edf712.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/pgbackrest-docs/" class="home-link router-link-active"><!----><span class="site-name">
      pgBackRest
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/pgbackrest-docs/guide/" class="nav-link router-link-active">Guide</a></div><div class="nav-item"><a href="/pgbackrest-docs/releases/" class="nav-link">Releases</a></div><div class="nav-item"><a href="/pgbackrest-docs/config/" class="nav-link">Configuration</a></div><div class="nav-item"><a href="/pgbackrest-docs/commands/" class="nav-link">Commands</a></div><a href="https://github.com/pgbackrest/pgbackrest" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/pgbackrest-docs/guide/" class="nav-link router-link-active">Guide</a></div><div class="nav-item"><a href="/pgbackrest-docs/releases/" class="nav-link">Releases</a></div><div class="nav-item"><a href="/pgbackrest-docs/config/" class="nav-link">Configuration</a></div><div class="nav-item"><a href="/pgbackrest-docs/commands/" class="nav-link">Commands</a></div><a href="https://github.com/pgbackrest/pgbackrest" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Guide</span><!----></p><ul class="sidebar-group-items"><li><a href="/pgbackrest-docs/guide/" class="sidebar-link">Introduction</a></li><li><a href="/pgbackrest-docs/guide/features.html" class="sidebar-link">Features</a></li><li><a href="/pgbackrest-docs/guide/concepts.html" class="sidebar-link">Concepts</a></li><li><a href="/pgbackrest-docs/guide/installation.html" class="sidebar-link">Installation</a></li><li><a href="/pgbackrest-docs/guide/quick_start.html" class="sidebar-link">Quick Start</a></li><li><a href="/pgbackrest-docs/guide/backup.html" class="sidebar-link">Backup</a></li><li><a href="/pgbackrest-docs/guide/monitoring.html" class="sidebar-link">Monitoring</a></li><li><a href="/pgbackrest-docs/guide/retention.html" class="sidebar-link">Retention</a></li><li><a href="/pgbackrest-docs/guide/restore.html" class="active sidebar-link">Restore</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pgbackrest-docs/guide/restore.html#delta-option" class="sidebar-link">Delta Option</a></li><li class="sidebar-sub-header"><a href="/pgbackrest-docs/guide/restore.html#restore-selected-databases" class="sidebar-link">Restore Selected Databases</a></li></ul></li><li><a href="/pgbackrest-docs/guide/point_in_time_recovery.html" class="sidebar-link">Point In Time Recovery</a></li><li><a href="/pgbackrest-docs/guide/s3_support.html" class="sidebar-link">AWS S3 Support</a></li><li><a href="/pgbackrest-docs/guide/deleting_stanza.html" class="sidebar-link">Deleting a Stanza</a></li><li><a href="/pgbackrest-docs/guide/dedicated_repository_host.html" class="sidebar-link">Dedicated Repository Host</a></li><li><a href="/pgbackrest-docs/guide/parallel_backup_restore.html" class="sidebar-link">Parallel Backup / Restore</a></li><li><a href="/pgbackrest-docs/guide/starting_and_stopping.html" class="sidebar-link">Starting And Stopping</a></li><li><a href="/pgbackrest-docs/guide/replication.html" class="sidebar-link">Replication</a></li><li><a href="/pgbackrest-docs/guide/asynchronous_archiving.html" class="sidebar-link">Asynchronous Archiving</a></li><li><a href="/pgbackrest-docs/guide/backup_from_standby.html" class="sidebar-link">Backup From a Standby</a></li><li><a href="/pgbackrest-docs/guide/upgrading_postgresql.html" class="sidebar-link">Upgrading PostgreSQL</a></li></ul></div></li></ul></div><div class="page"><div class="content"><h1 id="restore"><a href="#restore" aria-hidden="true" class="header-anchor">#</a> Restore</h1><p>The Restore section introduces additional restore command features.</p><h2 id="delta-option"><a href="#delta-option" aria-hidden="true" class="header-anchor">#</a> Delta Option</h2><p><a href="/pgbackrest-docs/guide/quick_start.html#restore_a_backup">Restore a Backup</a> in <a href="/pgbackrest-docs/guide/quick_start.html">Quick Start</a> required the database cluster directory to be cleaned before the restore could be performed. The delta option allows pgBackRest to automatically determine which files in the database cluster directory can be preserved and which ones need to be restored from the backup — it also removes files not present in the backup manifest so it will dispose of divergent changes. This is accomplished by calculating a <a href="https://en.wikipedia.org/wiki/SHA-1" target="_blank" rel="noopener noreferrer">SHA-1<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> cryptographic hash for each file in the database cluster directory. If the SHA-1 hash does not match the hash stored in the backup then that file will be restored. This operation is very efficient when combined with the process-max option. Since the PostgreSQL server is shut down during the restore, a larger number of processes can be used than might be desirable during a backup when the PostgreSQL server is running.</p><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># pg-primary ⇒ Stop the demo cluster, perform delta restore</span>
<span class="token function">sudo</span> pg_ctlcluster 9.4 demo stop
<span class="token function">sudo</span> -u postgres pgbackrest --stanza<span class="token operator">=</span>demo --delta \
       --log-level-console<span class="token operator">=</span>detail restore
       <span class="token punctuation">[</span>filtered 692 lines of output<span class="token punctuation">]</span>
P01 DETAIL: restore <span class="token function">file</span> /var/lib/postgresql/9.4/demo/base/12134/PG_VERSION - exists and matches backup <span class="token punctuation">(</span>4B, 99%<span class="token punctuation">)</span> checksum 8dbabb96e032b8d9f1993c0e4b9141e71ade01a1
P01 DETAIL: restore <span class="token function">file</span> /var/lib/postgresql/9.4/demo/base/1/PG_VERSION - exists and matches backup <span class="token punctuation">(</span>4B, 99%<span class="token punctuation">)</span> checksum 8dbabb96e032b8d9f1993c0e4b9141e71ade01a1
P01 DETAIL: restore <span class="token function">file</span> /var/lib/postgresql/9.4/demo/PG_VERSION - exists and matches backup <span class="token punctuation">(</span>4B, 100%<span class="token punctuation">)</span> checksum 8dbabb96e032b8d9f1993c0e4b9141e71ade01a1
P01 DETAIL: restore <span class="token function">file</span> /var/lib/postgresql/9.4/demo/global/12086 - exists and is zero size <span class="token punctuation">(</span>0B, 100%<span class="token punctuation">)</span>
P01 DETAIL: restore <span class="token function">file</span> /var/lib/postgresql/9.4/demo/global/12038 - exists and is zero size <span class="token punctuation">(</span>0B, 100%<span class="token punctuation">)</span>
       <span class="token punctuation">[</span>filtered 83 lines of output<span class="token punctuation">]</span>
P01 DETAIL: restore <span class="token function">file</span> /var/lib/postgresql/9.4/demo/base/1/11885 - exists and is zero size <span class="token punctuation">(</span>0B, 100%<span class="token punctuation">)</span>
P00   INFO: <span class="token function">write</span> /var/lib/postgresql/9.4/demo/recovery.conf
P00   INFO: restore global/pg_control <span class="token punctuation">(</span>performed last to ensure aborted restores cannot be started<span class="token punctuation">)</span>
P00   INFO: restore <span class="token function">command</span> end: completed successfully
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># pg-primary ⇒ Restart PostgreSQL</span>
<span class="token function">sudo</span> pg_ctlcluster 9.4 demo start
</code></pre></div><h2 id="restore-selected-databases"><a href="#restore-selected-databases" aria-hidden="true" class="header-anchor">#</a> Restore Selected Databases</h2><p>There may be cases where it is desirable to selectively restore specific databases from a cluster backup. This could be done for performance reasons or to move selected databases to a machine that does not have enough space to restore the entire cluster backup.</p><p>To demonstrate this feature two databases are created: test1 and test2. A fresh backup is run so pgBackRest is aware of the new databases.</p><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># pg-primary ⇒ Create two test databases and perform a backup</span>
<span class="token function">sudo</span> -u postgres psql -c <span class="token string">&quot;create database test1;&quot;</span>
CREATE DATABASE
<span class="token function">sudo</span> -u postgres psql -c <span class="token string">&quot;create database test2;&quot;</span>
CREATE DATABASE
<span class="token function">sudo</span> -u postgres pgbackrest --stanza<span class="token operator">=</span>demo --type<span class="token operator">=</span>incr backup
</code></pre></div><p>Each test database will be seeded with tables and data to demonstrate that recovery works with selective restore.</p><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># pg-primary ⇒ Create a test table in each database</span>
<span class="token function">sudo</span> -u postgres psql -c <span class="token string">&quot;create table test1_table (id int); \
       insert into test1_table (id) values (1);&quot;</span> test1
INSERT 0 1
<span class="token function">sudo</span> -u postgres psql -c <span class="token string">&quot;create table test2_table (id int); \
       insert into test2_table (id) values (2);&quot;</span> test2
INSERT 0 1
</code></pre></div><p>One of the main reasons to use selective restore is to save space. The size of the test1 database is shown here so it can be compared with the disk utilization after a selective restore.</p><div class="language-bash extra-class"><pre class="language-bash"><code>pg-primary ⇒ Show space used by test1 database
<span class="token function">sudo</span> -u postgres <span class="token function">du</span> -sh /var/lib/postgresql/9.4/demo/base/24576
6.5M	/var/lib/postgresql/9.4/demo/base/24576
</code></pre></div><p>Stop the cluster and restore only the <code>test2</code> database. Built-in databases (<code>template0</code>, <code>template1</code>, and <code>postgres</code>) are always restored.</p><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># pg-primary ⇒ Restore from last backup including only the test2 database</span>
<span class="token function">sudo</span> pg_ctlcluster 9.4 demo stop
<span class="token function">sudo</span> -u postgres pgbackrest --stanza<span class="token operator">=</span>demo --delta \
       --db-include<span class="token operator">=</span>test2 restore
<span class="token function">sudo</span> pg_ctlcluster 9.4 demo start
</code></pre></div><p>Once recovery is complete the test2 database will contain all previously created tables and data.</p><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># pg-primary ⇒ Demonstrate that the test2 database was recovered</span>
<span class="token function">sudo</span> -u postgres psql -c <span class="token string">&quot;select * from test2_table;&quot;</span> test2
 <span class="token function">id</span> 
----
  2
<span class="token punctuation">(</span>1 row<span class="token punctuation">)</span>
</code></pre></div><p>The test1 database, despite successful recovery, is not accessible. This is because the entire database was restored as sparse, zeroed files. PostgreSQL can successfully apply WAL on the zeroed files but the database as a whole will not be valid because key files contain no data. This is purposeful to prevent the database from being accidentally used when it might contain partial data that was applied during WAL replay.</p><div class="language-bash extra-class"><pre class="language-bash"><code>pg-primary ⇒ Attempting to connect to the test1 database will produce an error
<span class="token function">sudo</span> -u postgres psql -c <span class="token string">&quot;select * from test1_table;&quot;</span> test1
psql: FATAL:  relation mapping <span class="token function">file</span> <span class="token string">&quot;base/24576/pg_filenode.map&quot;</span> contains invalid data
</code></pre></div><p>Since the test1 database is restored with sparse, zeroed files it will only require as much space as the amount of WAL that is written during recovery. While the amount of WAL generated during a backup and applied during recovery can be significant it will generally be a small fraction of the total database size, especially for large databases where this feature is most likely to be useful.</p><p>It is clear that the test1 database uses far less disk space during the selective restore than it would have if the entire database had been restored.</p><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># pg-primary ⇒ Show space used by test1 database after recovery</span>
<span class="token function">sudo</span> -u postgres <span class="token function">du</span> -sh /var/lib/postgresql/9.4/demo/base/24576
152K	/var/lib/postgresql/9.4/demo/base/24576
</code></pre></div><p>At this point the only action that can be taken on the invalid test1 database is drop database. pgBackRest does not automatically drop the database since this cannot be done until recovery is complete and the cluster is accessible.</p><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># pg-primary ⇒ Drop the test1 database</span>
<span class="token function">sudo</span> -u postgres psql -c <span class="token string">&quot;drop database test1;&quot;</span>
DROP DATABASE
</code></pre></div><p>Now that the invalid test1 database has been dropped only the test2 and built-in databases remain.</p><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># pg-primary ⇒ List remaining databases</span>
<span class="token function">sudo</span> -u postgres psql -c <span class="token string">&quot;select oid, datname from pg_database order by oid;&quot;</span>
  oid  <span class="token operator">|</span>  datname  
-------+-----------
     1 <span class="token operator">|</span> template1
 12134 <span class="token operator">|</span> template0
 12139 <span class="token operator">|</span> postgres
 24577 <span class="token operator">|</span> test2
<span class="token punctuation">(</span>4 rows<span class="token punctuation">)</span>
</code></pre></div></div><div class="page-edit"><div class="edit-link"><a href="https://github.com/pgbackrest/pgbackrest/edit/master/guide/restore.md" target="_blank" rel="noopener noreferrer">Edit this page</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div><!----></div><div class="page-nav"><p class="inner"><span class="prev">
        ← <a href="/pgbackrest-docs/guide/retention.html" class="prev">
          Retention
        </a></span><span class="next"><a href="/pgbackrest-docs/guide/point_in_time_recovery.html">
          Point In Time Recovery
        </a> →
      </span></p></div></div></div></div>
    <script src="/pgbackrest-docs/assets/js/45.bf622f74.js" defer></script><script src="/pgbackrest-docs/assets/js/app.01ebea85.js" defer></script>
  </body>
</html>
